<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestore Telegram Immobiliare</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f7f6; padding: 40px 10px; }
        .card { border: none; border-radius: 15px; }
        .preview-card { display: none; border-left: 5px solid #0d6efd; background: #fff; }
        .img-preview { width: 100%; border-radius: 10px; height: 200px; object-fit: cover; background: #eee; }
        .spinner-border { width: 1.5rem; height: 1.5rem; }
        .upload-area { border: 2px dashed #ccc; padding: 10px; border-radius: 10px; text-align: center; margin-bottom: 15px; cursor: pointer; }
        .upload-area:hover { border-color: #0d6efd; background: #f8f9fa; }
    </style>
</head>
<body>

<div class="container" style="max-width: 500px;">
    <div class="card shadow-lg p-4">
        <h3 class="text-center mb-4">üè† Invio Rapido</h3>
        
        <div class="input-group mb-3">
            <input type="text" id="idImmobile" class="form-control" placeholder="ID o Rif (es: 12345)" aria-label="ID Immobile">
            <button class="btn btn-primary" onclick="cercaDati()" id="btnCerca">
                <i class="fa-solid fa-magnifying-glass"></i> Cerca
            </button>
        </div>

        <div class="upload-area" onclick="document.getElementById('fotoLocale').click()">
            <small class="text-muted"><i class="fa-solid fa-image"></i> Carica foto manuale (opzionale test)</small>
            <input type="file" id="fotoLocale" accept="image/*" style="display:none" onchange="anteprimaFotoLocale(this)">
            <div id="fileName" class="small fw-bold text-primary mt-1"></div>
        </div>

        <div id="loader" class="text-center d-none my-3">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="small text-muted">Recupero dati da Gabetti...</p>
        </div>

        <div id="preview" class="preview-card p-3 shadow-sm rounded">
            <img id="p-img" src="" class="img-preview mb-3">
            <h5 id="p-titolo" class="fw-bold text-primary"></h5>
            <div class="row small mb-3 text-secondary">
                <div class="col-6"><i class="fa-solid fa-ruler-combined"></i> <span id="p-mq"></span> m¬≤</div>
                <div class="col-6"><i class="fa-solid fa-bed"></i> <span id="p-camere"></span></div>
                <div class="col-6"><i class="fa-solid fa-bath"></i> <span id="p-bagni"></span></div>
                <div class="col-6"><i class="fa-solid fa-tag"></i> <span id="p-prezzo"></span></div>
            </div>
            <button class="btn btn-danger w-100 fw-bold" onclick="inviaATelegram()" id="btnInvia">
                <i class="fa-regular fa-paper-plane"></i> PUBBLICA SU TELEGRAM
            </button>
        </div>
    </div>
</div>

<script>
    // --- CONFIGURAZIONE ---
    const WORKER_URL = 'https://telegram-gabetti-bot.it-immobiliarenordest.workers.dev'; 
    let datiSalvati = null;
    let fotoBase64 = null; // Memorizza la foto caricata manualmente

    // Gestione caricamento foto manuale
    function anteprimaFotoLocale(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                fotoBase64 = e.target.result;
                document.getElementById('fileName').innerText = input.files[0].name;
                // Se la preview √® gi√† aperta, aggiorna l'immagine
                if(document.getElementById('preview').style.display === 'block') {
                    document.getElementById('p-img').src = fotoBase64;
                }
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    async function cercaDati() {
        const id = document.getElementById('idImmobile').value.trim();
        if (!id) return;

        setLoading(true);
        document.getElementById('preview').style.display = 'none';

        try {
            const r = await fetch(`${WORKER_URL}/get-immobile?id=${id}`);
            const data = await r.json();

            if (data && data.success) {
                datiSalvati = data;
                renderPreview(data);
            } else {
                alert("Immobile non trovato. Controlla l'ID.");
            }
        } catch (err) {
            alert("Errore di connessione al Worker.");
        } finally {
            setLoading(false);
        }
    }

    function renderPreview(d) {
        // Se c'√® una foto caricata manualmente, usa quella, altrimenti usa quella di Gabetti
        document.getElementById('p-img').src = fotoBase64 ? fotoBase64 : d.img;
        document.getElementById('p-titolo').innerText = `${d.tipologia} a ${d.comune}`;
        document.getElementById('p-mq').innerText = d.metri_quadri;
        document.getElementById('p-camere').innerText = d.camere + (d.camere == 1 ? " camera" : " camere");
        document.getElementById('p-bagni').innerText = d.bagni + (d.bagni == 1 ? " bagno" : " bagni");
        document.getElementById('p-prezzo').innerText = new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(d.prezzo);
        
        document.getElementById('preview').style.display = 'block';
    }

    async function inviaATelegram() {
        if (!datiSalvati) return;
        
        const btn = document.getElementById('btnInvia');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Invio in corso...';

        // Se l'utente ha caricato una foto, sostituiamo l'URL con la stringa Base64
        const payload = {
            ...datiSalvati,
            img: fotoBase64 ? fotoBase64 : datiSalvati.img
        };

        try {
            const r = await fetch(`${WORKER_URL}/send-telegram`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const result = await r.json();

            if (result.ok) {
                alert("‚úÖ Messaggio inviato correttamente!");
                location.reload();
            } else {
                alert("‚ùå Errore durante l'invio: " + (result.error || "Parametri non validi"));
            }
        } catch (e) {
            alert("Errore tecnico nell'invio.");
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="fa-regular fa-paper-plane"></i> PUBBLICA SU TELEGRAM';
        }
    }

    function setLoading(isLoading) {
        document.getElementById('loader').classList.toggle('d-none', !isLoading);
        document.getElementById('btnCerca').disabled = isLoading;
    }
</script>

</body>
</html>
