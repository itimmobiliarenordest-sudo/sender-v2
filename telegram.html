<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestore Telegram Immobiliare</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f7f6; padding: 40px 10px; }
        .card { border: none; border-radius: 15px; }
        .preview-card { display: none; border-left: 5px solid #0d6efd; background: #fff; }
        .img-preview { width: 100%; border-radius: 10px; height: 200px; object-fit: cover; background: #eee; cursor: pointer; }
        .spinner-border { width: 1.5rem; height: 1.5rem; }
        .upload-area { border: 2px dashed #ccc; padding: 10px; border-radius: 10px; text-align: center; margin-bottom: 15px; cursor: pointer; }
        .upload-area:hover { border-color: #0d6efd; background: #f8f9fa; }
        .form-label-sm { font-size: 0.8rem; font-weight: bold; color: #666; margin-bottom: 2px; }
        #status-banner { font-size: 0.75rem; padding: 4px; border-radius: 8px; margin-bottom: 15px; display: none; }
    </style>
</head>
<body>

<div class="container" style="max-width: 500px;">
    <div id="status-banner" class="text-center fw-bold shadow-sm"></div>

    <div class="card shadow-lg p-4">
        <h3 id="main-title" class="text-center mb-4">üè† Invio Telegram</h3>
        
        <div class="input-group mb-3">
            <input type="text" id="idImmobile" class="form-control" placeholder="ID (es: 12345)">
            <button class="btn btn-primary" onclick="cercaDati()" id="btnCerca">
                <i class="fa-solid fa-magnifying-glass"></i> Carica
            </button>
        </div>

        <div class="upload-area" onclick="document.getElementById('fotoLocale').click()">
            <small class="text-muted"><i class="fa-solid fa-camera"></i> Cambia foto (opzionale)</small>
            <input type="file" id="fotoLocale" accept="image/*" style="display:none" onchange="anteprimaFotoLocale(this)">
            <div id="fileName" class="small fw-bold text-primary mt-1"></div>
        </div>

        <div id="loader" class="text-center d-none my-3">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="small text-muted">Interrogazione API...</p>
        </div>

        <div id="preview" class="preview-card p-3 shadow-sm rounded">
            <img id="p-img" src="" class="img-preview mb-3" onclick="document.getElementById('fotoLocale').click()" title="Clicca per cambiare foto">
            
            <div class="mb-2">
                <label class="form-label-sm">TITOLO / TIPOLOGIA</label>
                <input type="text" id="edit-titolo" class="form-control form-control-sm">
            </div>

            <div class="row g-2 mb-2">
                <div class="col-6">
                    <label class="form-label-sm">COMUNE</label>
                    <input type="text" id="edit-comune" class="form-control form-control-sm">
                </div>
                <div class="col-6">
                    <label class="form-label-sm">PREZZO</label>
                    <input type="text" id="edit-prezzo" class="form-control form-control-sm" placeholder="Es: 155000 o 0">
                </div>
            </div>

            <div class="row g-2 mb-3">
                <div class="col-4">
                    <label class="form-label-sm">MQ</label>
                    <input type="text" id="edit-mq" class="form-control form-control-sm">
                </div>
                <div class="col-4">
                    <label class="form-label-sm" id="label-camere">CAMERE</label>
                    <input type="text" id="edit-camere" class="form-control form-control-sm">
                </div>
                <div class="col-4">
                    <label class="form-label-sm">BAGNI</label>
                    <input type="text" id="edit-bagni" class="form-control form-control-sm">
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label-sm">LINK SITO GABETTI</label>
                <input type="text" id="edit-link" class="form-control form-control-sm">
            </div>

            <button class="btn btn-danger w-100 fw-bold py-2" onclick="inviaATelegram()" id="btnInvia">
                <i class="fa-regular fa-paper-plane"></i> INVIA ORA
            </button>
        </div>
    </div>
</div>

<script>
    const WORKER_URL = 'https://telegram-gabetti-bot.it-immobiliarenordest.workers.dev'; 
    let fotoBase64 = null;
    let urlOriginaleFoto = "";

    async function controllaStato() {
        const title = document.getElementById('main-title');
        const banner = document.getElementById('status-banner');
        
        try {
            const r = await fetch(`${WORKER_URL}/get-status`);
            const status = await r.json();
            
            banner.style.display = 'block';
            if (status.debug) {
                title.innerHTML = "‚ö†Ô∏è TEST di Invio";
                title.classList.add("text-warning");
                banner.innerHTML = "MODALIT√Ä TEST ATTIVA (Invio solo a ID Personale)";
                banner.className = "alert alert-warning text-center fw-bold shadow-sm";
            } else {
                title.innerHTML = "üè† Invio Telegram";
                title.classList.add("text-success");
                banner.innerHTML = "MODALIT√Ä LIVE (Canale e Gruppo Attivi)";
                banner.className = "alert alert-success text-center fw-bold shadow-sm";
            }
        } catch (e) {
            console.warn("Stato del worker non raggiungibile.");
        }
    }

    window.onload = controllaStato;

    function anteprimaFotoLocale(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                fotoBase64 = e.target.result;
                document.getElementById('fileName').innerText = input.files[0].name;
                document.getElementById('p-img').src = fotoBase64;
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    async function cercaDati() {
        const id = document.getElementById('idImmobile').value.trim();
        if (!id) return;

        setLoading(true);
        document.getElementById('preview').style.display = 'none';
        fotoBase64 = null; 
        document.getElementById('fileName').innerText = "";

        try {
            const r = await fetch(`${WORKER_URL}/get-immobile?id=${id}`);
            const data = await r.json();

            if (data && data.success) {
                popolaCampi(data);
            } else {
                alert("Immobile non trovato.");
            }
        } catch (err) {
            alert("Errore connessione.");
        } finally {
            setLoading(false);
        }
    }

    function popolaCampi(d) {
        urlOriginaleFoto = d.img;
        document.getElementById('p-img').src = d.img;
        document.getElementById('edit-titolo').value = d.tipologia;
        document.getElementById('edit-comune').value = d.comune;
        document.getElementById('edit-mq').value = d.metri_quadri;
        document.getElementById('edit-camere').value = d.camere;
        document.getElementById('edit-bagni').value = d.bagni;
        document.getElementById('edit-prezzo').value = d.prezzo;
        document.getElementById('edit-link').value = d.link;
        
        // --- LOGICA LOCALI / TERRENO ---
        const labelCamere = document.getElementById('label-camere');
        const divCamere = document.getElementById('edit-camere').parentElement;
        const divBagni = document.getElementById('edit-bagni').parentElement;

        // Aggiorna etichetta (Camere o Locali)
        if (labelCamere) {
            labelCamere.innerText = d.camereLabel ? d.camereLabel.toUpperCase() : "CAMERE";
        }

        // Se Terreno, sbiadisce campi inutili
        if (d.tipologia === "Terreno") {
            divCamere.style.opacity = "0.3";
            divBagni.style.opacity = "0.3";
        } else {
            divCamere.style.opacity = "1";
            divBagni.style.opacity = "1";
        }
        
        document.getElementById('preview').style.display = 'block';
    }

    async function inviaATelegram() {
        const btn = document.getElementById('btnInvia');
        btn.disabled = true;
        btn.innerHTML = 'Invio in corso...';

        const payload = {
            tipologia: document.getElementById('edit-titolo').value,
            comune: document.getElementById('edit-comune').value,
            metri_quadri: document.getElementById('edit-mq').value,
            camere: document.getElementById('edit-camere').value,
            bagni: document.getElementById('edit-bagni').value,
            prezzo: document.getElementById('edit-prezzo').value,
            link: document.getElementById('edit-link').value,
            img: fotoBase64 ? fotoBase64 : urlOriginaleFoto
        };

        try {
            const r = await fetch(`${WORKER_URL}/send-telegram`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const result = await r.json();
            if (result.ok) {
                alert("‚úÖ Messaggi inviati con successo!");
                location.reload();
            } else {
                alert("‚ùå Errore Telegram: " + (result.details?.description || "Sconosciuto"));
            }
        } catch (e) {
            alert("Errore tecnico durante l'invio.");
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="fa-regular fa-paper-plane"></i> INVIA ORA';
        }
    }

    function setLoading(isLoading) {
        document.getElementById('loader').classList.toggle('d-none', !isLoading);
        document.getElementById('btnCerca').disabled = isLoading;
    }
</script>

</body>
</html>
